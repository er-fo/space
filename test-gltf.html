<!DOCTYPE html>
<html>
<head>
    <title>GLTF Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
    <div id="test-result"></div>
    <script>
        // Test GLTF loading
        async function testGLTF() {
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: 'Create a 20mm cube' })
                });
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.success && data.gltf) {
                    console.log('GLTF content type:', typeof data.gltf);
                    console.log('GLTF length:', data.gltf.length);
                    console.log('GLTF starts with:', data.gltf.substring(0, 50));
                    
                    // Test Three.js GLTF loading
                    const loader = new THREE.GLTFLoader();
                    
                    if (data.gltf.startsWith('data:model/gltf-binary;base64,')) {
                        console.log('Testing binary GLTF loading...');
                        const base64Data = data.gltf.split(',')[1];
                        const binaryString = atob(base64Data);
                        const arrayBuffer = new ArrayBuffer(binaryString.length);
                        const view = new Uint8Array(arrayBuffer);
                        for (let i = 0; i < binaryString.length; i++) {
                            view[i] = binaryString.charCodeAt(i);
                        }
                        
                        loader.parse(arrayBuffer, '', (gltf) => {
                            console.log('✓ Binary GLTF loaded successfully!', gltf);
                            document.getElementById('test-result').innerHTML = '✓ Binary GLTF loaded successfully!';
                        }, (error) => {
                            console.error('✗ Binary GLTF loading failed:', error);
                            document.getElementById('test-result').innerHTML = '✗ Binary GLTF loading failed: ' + error.message;
                        });
                    } else {
                        console.log('Testing JSON GLTF loading...');
                        const gltfData = JSON.parse(data.gltf);
                        loader.parse(gltfData, '', (gltf) => {
                            console.log('✓ JSON GLTF loaded successfully!', gltf);
                            document.getElementById('test-result').innerHTML = '✓ JSON GLTF loaded successfully!';
                        }, (error) => {
                            console.error('✗ JSON GLTF loading failed:', error);
                            document.getElementById('test-result').innerHTML = '✗ JSON GLTF loading failed: ' + error.message;
                        });
                    }
                } else {
                    console.error('No GLTF in response:', data);
                    document.getElementById('test-result').innerHTML = 'No GLTF in response';
                }
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('test-result').innerHTML = 'Test failed: ' + error.message;
            }
        }
        
        // Run test when page loads
        window.onload = testGLTF;
    </script>
</body>
</html>
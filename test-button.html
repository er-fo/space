<!DOCTYPE html>
<html>
<head>
    <title>Button Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
    <div id="viewer-status">Ready to generate...</div>
    <input type="text" id="demo-input" placeholder="Describe your 3D model..." value="Create a 20mm cube" />
    <button onclick="submitDemo()" id="demo-submit">Generate 3D Model</button>
    <div id="test-result"></div>
    
    <script>
        let demoUsed = false;
        
        function submitDemo() {
            console.log('submitDemo called');
            document.getElementById('test-result').innerHTML = 'submitDemo called successfully!';
            
            if (demoUsed) {
                console.log('Demo already used, returning');
                return;
            }
            
            const input = document.getElementById('demo-input');
            const prompt = input.value.trim();
            
            console.log('Prompt:', prompt);
            
            if (!prompt) {
                console.log('No prompt, returning');
                return;
            }
            
            demoUsed = true;
            
            // Update status
            document.getElementById('viewer-status').textContent = 'Generating model...';
            
            // Disable input and suggestions
            input.disabled = true;
            document.getElementById('demo-submit').disabled = true;
            
            // Generate model
            generateModel(prompt);
        }
        
        async function generateModel(prompt) {
            console.log('generateModel called with:', prompt);
            document.getElementById('test-result').innerHTML += '<br>generateModel called with: ' + prompt;
            
            let statusInterval;
            
            try {
                // Configuration - Using Fly.io backend for complete pipeline
                const BACKEND_URL = window.location.origin;
                
                // Start progressive status updates
                const statusMessages = [
                    'Parsing your prompt...',
                    'Generating CAD plan...',
                    'Writing Python code...',
                    'Creating 3D model...',
                    'Converting to GLTF...',
                    'Finalizing model...'
                ];
                
                let messageIndex = 0;
                document.getElementById('viewer-status').textContent = statusMessages[messageIndex++];
                
                // Update status every 5 seconds
                statusInterval = setInterval(() => {
                    if (messageIndex < statusMessages.length) {
                        document.getElementById('viewer-status').textContent = statusMessages[messageIndex++];
                    }
                }, 5000);
                
                // Set up timeout (60 seconds)
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('Request timed out after 60 seconds'));
                    }, 60000);
                });
                
                // Make the API request with timeout
                const fetchPromise = fetch(BACKEND_URL + '/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });
                
                document.getElementById('test-result').innerHTML += '<br>Making API request...';
                
                const pipelineResponse = await Promise.race([fetchPromise, timeoutPromise]);
                
                // Clear the status interval
                clearInterval(statusInterval);
                
                const pipeline = await pipelineResponse.json();
                console.log('Pipeline response:', pipeline);
                
                document.getElementById('test-result').innerHTML += '<br>API response received: ' + JSON.stringify(pipeline).substring(0, 100) + '...';
                
                if (pipeline.success) {
                    document.getElementById('viewer-status').textContent = 'Model generated successfully!';
                    document.getElementById('test-result').innerHTML += '<br>✓ SUCCESS: Model generated!';
                } else {
                    document.getElementById('viewer-status').textContent = 'Error: ' + pipeline.error;
                    document.getElementById('test-result').innerHTML += '<br>✗ ERROR: ' + pipeline.error;
                }
                
            } catch (error) {
                console.error('Error generating model:', error);
                
                // Clear any running status interval
                if (statusInterval) {
                    clearInterval(statusInterval);
                }
                
                document.getElementById('viewer-status').textContent = 'Error: ' + error.message;
                document.getElementById('test-result').innerHTML += '<br>✗ EXCEPTION: ' + error.message;
            }
        }
        
        // Test on page load
        window.onload = function() {
            console.log('Page loaded, testing button...');
            document.getElementById('test-result').innerHTML = 'Page loaded, ready to test button';
        };
    </script>
</body>
</html>